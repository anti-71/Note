# 第二章 80x86计算机组织

## 2.1 **计算机系统**

### 一、计算机系统的宏观组成

计算机系统由**硬件**和**软件**构成：

- 硬件：通过系统总线连接，包括：
  - **中央处理器（CPU）**：核心运算与控制单元
  - **总线控制逻辑**：协调总线数据传输
  - **存储器**：临时存储程序和数据（如主存 ）
  - **接口与 I/O 子系统**：连接大容量存储（如磁盘 ）、I/O 设备（如显示器、键盘 ）
- 软件：分为**系统软件**（如操作系统，管理硬件资源 ）和**用户软件**（如应用程序，满足特定需求 ）

### 二、硬件架构细节

#### 1. CPU 内部组件

- **PC（程序计数器）**：记录下一条要执行的指令地址
- **寄存器文件**：高速存储单元，临时存放数据$/$指令
- **ALU（算术逻辑单元）**：执行算术（加减乘除 ）和逻辑运算（与或非等 ）
- **总线接口**：连接 CPU 与**系统总线**，负责数据收发

#### 2. 总线体系

- **系统总线**：连接 CPU 和**I/O 桥**，传输 CPU 与内存、外设的交互数据
- **内存总线**：连接 I/O 桥与**主存（Main memory）**，高速传输程序 / 数据
- **I/O 总线**：连接 I/O 桥与外设控制器，如：
  - USB 控制器→鼠标、键盘；
  - 图形适配器→显示器；
  - 磁盘控制器→磁盘（持久存储设备 ）

### 三、程序运行流程：以`hello.c`为例

通过 **“存储→加载→执行→输出”** 四阶段，展示数据在硬件中的流动：

#### 1. 存储：程序存于磁盘

`hello.c`经编译生成**可执行文件**，长期存储在**磁盘**（持久存储，掉电数据不丢 ）

#### 2. 加载：从磁盘到主存

运行程序时：

- 磁盘控制器通过**I/O 总线**读取可执行文件，经**I/O 桥**转发到**系统总线**，最终加载到**主存**（临时存储，运行时快速访问 ）
- 主存中同时存放：程序代码（如`printf`指令 ）和数据（如字符串`"hello, world\n"` ）

#### 3. 执行：CPU 运算与控制

PC指向主存中第一条指令地址，CPU 依次取指令、解码、执行：ALU 处理运算（如解析`printf`逻辑 ），寄存器暂存中间数据，总线接口协调数据在 CPU、主存间的传输

#### 4. 输出：从主存到显示器

`printf`需输出字符串时，数据从主存经**系统总线→I/O 桥→I/O 总线**，传至**图形适配器**，最终在**显示器**上显示`"hello, world\n"`

## 2.2 **存储器**

### 一、存储器基础

- **存储单位**：以**字节（8bit）**为基本存储单元，每个字节有唯一地址，从0开始顺序编号
- **地址表示**：二进制无符号整数，常写为十六进制
- **字存储规则**：
  - 1 个字占**连续 2 字节**，低位字节存**低地址**、高位字节存**高地址**（小端模式体现 ）
  - 机器以**偶地址**访问存储器，字单元地址用**低地址**表示

### 二、存储数据与字节序

- **字节存储**：地址`1000H`存放`9FH`、`1001H`存放`26H`，体现单字节数据存储
- **字数据组合**：地址`1000H`对应的字为`269FH`（低地址存低位`9F`，高地址存高位`26`）；
- **字节序对比**：`0x01234567`数据，**小端模式**下低地址存低位（`67`），高地址存高位（`01`）；大端模式相反，体现不同架构存储差异

### 三、存储器分段

#### 物理地址计算逻辑

**地址线与寻址范围**：20 根地址线对应物理地址范围`00000H~FFFFFH`（1MB）；16位机器字长仅能直接表示`0000H~FFFFH`（64KB），需**分段管理**突破限制

**分段规则**：

- 每16字节为1“小段”，共`64K`个小段，段首地址末位为`0`（如`00000H`、`00010H`等 ）

- 物理地址公式：

  ```
  物理地址 = 16d × 段地址 + 偏移地址
  ```

  - 段地址：段起始地址的**高16位（相当于16进制左移1位）**（存于段寄存器）
  - 偏移地址（有效地址EA ）：段内相对于段首的16位偏移量

### 四、逻辑分段与段寄存器

- **段寄存器作用**：通过`CS`（代码段 ）、`DS`（数据段 ）、`SS`（堆栈段 ）、`ES`（附加段 ）管理不同功能的64KB逻辑段，实现内存的**逻辑划分**（如代码、数据、堆栈分离 ）
- 示例：
  - 段寄存器`CS=0150H`对应存储器`01500H`开始的64K代码段
  - 小容量段示例（如 8K代码段、2K数据段 ），体现分段可按需调整大小（≤64KB ）

### 五、地址映射灵活性

**地址重叠**：同一物理地址可由**不同段地址 + 偏移地址**组合生成（如`05234H` 可由`0400H+1234H`、`0523H+0004H`等构成 ），体现分段管理的**地址映射灵活性**，支持内存复用与高效访问

## 2.3 **中央处理机**

### 一、CPU 组成与寄存器分类

- **CPU 核心构成**：由**算术逻辑部件（ALU）**（处理运算）、**控制逻辑**（协调指令执行）、**工作寄存器**（临时存数据$/$地址 ）组成
- **8086/8088 寄存器组**：
  - **数据寄存器**：`AX`$/$`BX`$/$`CX`$/$`DX`，可拆分为高8位（如`AH`）、低8位（如`AL` ），灵活处理字节$/$字数据
  - **指针及变址寄存器**：`SP`（堆栈指针 ）、`BP`（基址指针 ）、`SI`（源变址 ）、`DI`（目的变址 ），用于内存寻址
  - **段寄存器**：`CS`（代码段 ）、`DS`（数据段 ）、`SS`（堆栈段 ）、`ES`（附加段 ），配合分段管理内存
  - **控制寄存器**：`IP`（指令指针，存下条指令地址）、`FLAGS`（标志寄存器，记录运算状态$/$控制标志 ）

### 二、标志寄存器（PSW）详解

- 16 位标志寄存器：按功能分为**条件码标志**（反映运算结果状态 ）和**控制标志**（调控 CPU 行为 ）：
  - 条件码标志：
    - `OF`（溢出标志 ）：运算结果溢出时置 1；
    - `SF`（符号标志 ）：结果为负则置 1（同最高位 ）；
    - `ZF`（零标志 ）：结果为 0 则置 1；
    - `CF`（进位标志 ）：无符号数运算进位 / 借位时置 1；
    - `AF`（辅助进位标志 ）：低 4 位进位 / 借位时置 1（用于 BCD 码 ）；
    - `PF`（奇偶标志 ）：结果低 8 位 “1” 的个数为偶数则置 1。
  - 控制标志：
    - `DF`（方向标志 ）：决定串操作地址增减方向（0 增、1 减 ）；
    - `IF`（中断标志 ）：置 1 则允许可屏蔽中断；
    - `TF`（陷阱标志 ）：置 1 则进入单步调试模式。

### 三、寄存器 vs 存储器

| **维度**   | **寄存器**                      | **存储器**                            |
| ---------- | ------------------------------- | ------------------------------------- |
| 物理位置   | CPU 内部                        | CPU 外部                              |
| 访问速度   | 极快（无需总线交互 ）           | 较慢（依赖总线传输 ）                 |
| 容量与成本 | 容量小、成本高（集成于 CPU ）   | 容量大、成本低（独立芯片 / 硬盘 ）    |
| 标识方式   | 用名称（如`AX`、`CS` ）直接访问 | 用地址（如内存地址、磁盘扇区 ）访问   |
| 地址特性   | 无独立地址（CPU 直接调度 ）     | 地址需通过总线、分段 / 分页等机制生成 |

## 2.4 外部设备

### 一、外部设备与接口

- **通信机制**：外部设备通过**外设接口**（Interface）与主机（CPU + 存储器）通信，接口内含 3 类寄存器：
  - **数据寄存器**：存外设与主机间传输的数据
  - **状态寄存器**：存外设 / 接口的状态信息（如是否就绪 ）
  - **命令寄存器**：存 CPU 发往外设 / 接口的控制命令
- **地址空间**：外设寄存器对应**端口（Port）地址**，构成独立于内存的 I/O 地址空间（`0000H ~ FFFFH` ）

### 二、80x86 寄存器体系

#### 1. 程序可见寄存器分类

- **通用寄存器**：`EAX`/`EBX`/`ECX`/`EDX`（可拆分为高低 8 位，如`AH`/`AL` ）、`ESP`/`EBP`/`ESI`/`EDI`（支持堆栈、变址寻址 ）
- **专用寄存器**：`EIP`（指令指针，存下条指令地址 ）、`EFLAGS`（标志寄存器，记录运算状态 / 控制标志 ）
- **段寄存器**：`CS`/`DS`/`SS`/`ES`/`FS`/`GS`（管理内存分段，关联描述符表 ）

#### 2. 标志寄存器（EFLAGS）演进

不同架构（8086/8088→80286→80386→80486→Pentium ）的标志位扩展：

- 基础标志（如`OF`/`DF`/`IF`/`TF`/`SF`/`ZF`/`AF`/`PF`/`CF` ）保持核心功能（反映运算状态、控制 CPU 行为 ）
- 新增标志（如`IOPL`/`NT`/`RF`/`VM`/`AC`/`ID`/`VIP`/`VIF` ）支持特权级、虚拟模式、调试等高级功能

### 三、保护模式与存储器寻址

#### 1. 保护模式特性

支持**多任务处理**（并行运行多个程序 ）和**虚拟存储器**（扩展地址空间、隔离进程内存 ）

#### 2. 存储器寻址机制

**逻辑地址→物理地址转换**：

- 逻辑地址 = `选择器（16位，存段寄存器 ）` + `偏移地址（32位 ）`
- 选择器指向**描述符表**（存于存储器 ）中的描述符，描述符含段基地址、大小、权限等信息
- 结合段基地址与偏移地址，生成物理地址访问存储器

#### 3. 描述符与描述符表

- **描述符**：8 字节长，定义段的大小、位置、权限（基地址、界限、访问权等 ），由系统设置
- **描述符表**：存于存储器，分 3 类：
  - 全局描述符表（GDT ）：系统级段描述符
  - 局部描述符表（LDT ）：进程级段描述符
  - 中断描述符表（IDT ）：中断服务程序描述符

### 四、程序不可见寄存器

- **GDTR**（全局描述符表寄存器 ）、**IDTR**（中断描述符表寄存器 ）：存对应描述符表的基地址和界限值
- **LDTR**（局部描述符表寄存器 ）：关联进程的局部描述符表
- **TR**（任务寄存器 ）：管理多任务切换，存当前任务状态
- **高速缓冲存储器（cache）**：虽未详述，属存储层级（加速 CPU 与内存的数据交互 ）